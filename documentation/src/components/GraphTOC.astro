---
import { getCollection } from 'astro:content';

interface Node {
  id: string;
  name: string;
  val: number;
  type: 'post' | 'tag';
  slug?: string;
  x?: number;
  y?: number;
  __bckgDimensions?: number[];
}

interface Link {
  source: string;
  target: string;
}

const posts = await getCollection('blog');

const nodes: Node[] = [];
const links: Link[] = [];
const tagsSet = new Set<string>();

posts.forEach((post) => {
  // Add post node
  nodes.push({
    id: post.id,
    name: post.data.title,
    val: 20, // larger size for posts
    type: 'post',
    slug: post.id
  });

  if (post.data.tags) {
    post.data.tags.forEach(tag => {
      tagsSet.add(tag);
      links.push({
        source: post.id,
        target: tag
      });
    });
  }
});

// Add tag nodes
tagsSet.forEach(tag => {
  nodes.push({
    id: tag,
    name: "#" + tag,
    val: 10, // smaller size for tags
    type: 'tag'
  });
});

const graphData = { nodes, links };
---

<div id="graph-container"></div>

<script is:inline src="//unpkg.com/force-graph"></script>
<script define:vars={{ graphData }}>
  const elem = document.getElementById('graph-container');

  const Graph = ForceGraph()(elem)
    .graphData(graphData)
    .nodeLabel('name')
    .nodeColor(node => node.type === 'post' ? '#a78bfa' : '#4ade80') // Purple for posts, Green for tags
    .nodeVal('val')
    .linkColor(() => '#ffffff50') // Semi-transparent white links
    .backgroundColor('#00000000') // Transparent background
    .onNodeClick(node => {
      if (node.type === 'post') {
        window.location.href = `/blog/${node.slug}`;
      } else {
        // Optional: Filter by tag or zoom in?
        // For now, just focus or highlight?
        Graph.centerAt(node.x, node.y, 1000);
        Graph.zoom(8, 2000);
      }
    })
    .nodeCanvasObject((node, ctx, globalScale) => {
      const label = node.name;
      const fontSize = 12/globalScale;
      ctx.font = `${fontSize}px Sans-Serif`;
      const textWidth = ctx.measureText(label).width;
      const bckgDimensions = [textWidth, fontSize].map(n => n + fontSize * 0.2); // some padding

      ctx.fillStyle = 'rgba(255, 255, 255, 0.0)'; // Transparent background for text
      
      // Draw circle
      ctx.beginPath();
      const r = Math.sqrt(node.val) * 2;
        ctx.fillStyle = node.type === 'post' ? '#646cff' : '#42b883'; // Astro colors roughly
        if(node.type === 'post') {
             ctx.arc(node.x, node.y, r, 0, 2 * Math.PI, false);
             ctx.fill();
        } else {
            ctx.fillStyle = '#888888';
            ctx.arc(node.x, node.y, r/1.5, 0, 2 * Math.PI, false);
            ctx.fill();
        }


      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = node.type === 'post' ? '#fff' : '#ddd';
      
      // Show label below the node
      ctx.fillText(label, node.x, node.y + r + fontSize);

      node.__bckgDimensions = bckgDimensions; // to re-use in nodePointerAreaPaint
    })
    .nodePointerAreaPaint((node, color, ctx) => {
        const r = Math.sqrt(node.val) * 2;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(node.x, node.y, r, 0, 2 * Math.PI, false);
        ctx.fill();
    });

    // Fit to canvas
    Graph.d3Force('charge').strength(-100);
</script>

<style>
  #graph-container {
    width: 100%;
    height: 60vh; /* Takes up 60% of viewport height */
    position: relative;
    z-index: 10;
    cursor: grab;
    backdrop-filter: blur(2px);
    border-radius: 1rem;
    overflow: hidden;
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(20, 20, 30, 0.4);
  }
</style>
